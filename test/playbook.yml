#!/usr/bin/env ansible-playbook
---
- hosts: all

  pre_tasks:
    - name: Check Ansible version
      ansible.builtin.assert:
        that: ansible_version.full is version_compare('2.9', '>=')
        msg: The Ansible version is too old for this notebook

  tasks:
    - name: Set custom timezone
      become: yes
      timezone:
        name: Europe/Rome

    - name: Execute apt update if the last one is more than 1 hour ago
      become: yes
      apt:
        update_cache: yes
        cache_valid_time: 3600
      when: ansible_pkg_mgr == "apt"

    - name: Ensure some packages are installed
      become: yes
      package:
        name:
          - rsync # Needed by the "synchronize" Ansible module
          - git
          - nano
          - tmux
          - tree
          - wget
          - zip
          - curl
          - socat
          - jq

    - name: Pull the nginx Docker image
      docker_image:
        name: nginx
        source: pull

    - name: Main container
      docker_container:
        name: nginx-example
        image: nginx
        keep_volumes: no # Do not retain **anonymous** volumes when the container is removed
        restart_policy: always
        ports:
          - 80:80
